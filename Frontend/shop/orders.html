<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Orders | LocalPick Shop</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="../static/css/styles.css">
  <link rel="stylesheet" href="../static/css/shop.css">
</head>
<body class="auth-body">
  <div data-include="../includes/header.html"></div>
  <main class="shop-shell">
    <div class="container shop-grid">
      <div class="card">
        <div class="toolbar">
          <div>
            <h2>Orders</h2>
            <p class="helper-text">Track and manage customer orders.</p>
          </div>
          <a class="ghost-btn" href="index.html"><i class="bi bi-arrow-left"></i> Dashboard</a>
        </div>
        <div class="toolbar">
          <input type="search" id="order-search" placeholder="Search order ID / phone">
          <select id="order-status">
            <option value="">All status</option>
            <option value="pending">Pending</option>
            <option value="confirmed">Confirmed</option>
            <option value="packed">Packed</option>
            <option value="out_for_delivery">Out for delivery</option>
            <option value="delivered">Delivered</option>
            <option value="cancelled">Cancelled</option>
          </select>
          <button class="ghost-btn" id="apply-orders"><i class="bi bi-filter"></i> Apply</button>
        </div>
        <div class="page-status"></div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Order ID</th>
                <th>Customer</th>
                <th>Phone</th>
                <th>Total</th>
                <th>Status</th>
                <th>Date</th>
              </tr>
            </thead>
            <tbody id="order-rows">
              <tr><td colspan="6">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <script src="../static/js/includes.js"></script>
  <script src="../static/js/shop-api.js"></script>
  <script>
    (function () {
      const shopId = getShopId();
      const rowsEl = document.getElementById("order-rows");
      const statusFilter = document.getElementById("order-status");
      const searchInput = document.getElementById("order-search");

      if (!shopId) {
        renderStatus("No shop found. Create your shop in Settings first.", "error");
        rowsEl.innerHTML = "<tr><td colspan='6'>Create a shop first.</td></tr>";
        return;
      }

      async function loadOrders() {
        const params = new URLSearchParams();
        params.set("shopId", shopId);
        if (statusFilter.value) params.set("status", statusFilter.value);
        if (searchInput.value) params.set("q", searchInput.value);
        try {
          const data = await apiFetch(`/orders?${params.toString()}`);
          const items = data.items || [];
          rowsEl.innerHTML =
            items
              .map(
                (o) => `<tr>
              <td><a href="order_details.html?id=${o._id}">${o._id}</a></td>
              <td>${o.customer?.name || ""}</td>
              <td>${o.customer?.phone || ""}</td>
              <td>à§³ ${o.totals?.grandTotal ?? 0}</td>
              <td><span class="status-pill ${o.status}">${o.status.replace(/_/g, " ")}</span></td>
              <td>${new Date(o.createdAt).toLocaleString()}</td>
            </tr>`
              )
              .join("") || "<tr><td colspan='6'>No orders found.</td></tr>";
        } catch (err) {
          renderStatus(err.message, "error");
        }
      }

      document.getElementById("apply-orders").addEventListener("click", loadOrders);
      loadOrders();
    })();
  </script>
</body>
</html>
