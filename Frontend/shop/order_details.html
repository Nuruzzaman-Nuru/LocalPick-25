<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Order Details | LocalPick Shop</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="../static/css/styles.css">
  <link rel="stylesheet" href="../static/css/shop.css">
</head>
<body class="auth-body">
  <div data-include="../includes/header.html"></div>
  <main class="shop-shell">
    <div class="container shop-grid">
      <div class="card">
        <div class="toolbar">
          <div>
            <h2>Order Details</h2>
            <p class="helper-text" id="order-id">Loading...</p>
          </div>
          <a class="ghost-btn" href="orders.html"><i class="bi bi-arrow-left"></i> Back</a>
        </div>
        <div class="page-status"></div>
        <div id="order-content" class="grid-2"></div>
      </div>
    </div>
  </main>

  <script src="../static/js/includes.js"></script>
  <script src="../static/js/shop-api.js"></script>
  <script>
    (function () {
      const orderId = qs("id");
      const content = document.getElementById("order-content");
      const statusEl = document.querySelector(".page-status");
      if (!orderId) {
        content.innerHTML = "<p>Missing order ID.</p>";
        return;
      }

      function renderOrder(order) {
        document.getElementById("order-id").textContent = `Order ID: ${order._id}`;
        const items = (order.items || [])
          .map(
            (i) => `<li>${i.name} x ${i.quantity} @ ৳ ${i.price} = ৳ ${i.lineTotal}</li>`
          )
          .join("");

        content.innerHTML = `
          <div class="card">
            <h3>Order Info</h3>
            <p>Status: <span class="status-pill ${order.status}">${order.status.replace(/_/g, " ")}</span></p>
            <p>Placed: ${new Date(order.createdAt).toLocaleString()}</p>
            <label style="margin-top:10px;display:block;">Change Status
              <select id="status-select">
                <option value="pending">Pending</option>
                <option value="confirmed">Confirmed</option>
                <option value="packed">Packed</option>
                <option value="out_for_delivery">Out for delivery</option>
                <option value="delivered">Delivered</option>
                <option value="cancelled">Cancelled</option>
              </select>
            </label>
            <button class="primary-btn" id="save-status" style="margin-top:10px;">Save Status</button>
          </div>
          <div class="card">
            <h3>Customer</h3>
            <p>${order.customer?.name || ""}</p>
            <p>${order.customer?.phone || ""}</p>
            <p>${order.customer?.address || ""}</p>
            <p>${order.customer?.area || ""}</p>
            <h3 style="margin-top:12px;">Payment</h3>
            <p>Method: ${order.paymentMethod}</p>
            <p>Totals: Subtotal ৳ ${order.totals?.subtotal ?? 0}, Delivery ৳ ${order.totals?.deliveryCharge ?? 0}, Grand ৳ ${order.totals?.grandTotal ?? 0}</p>
          </div>
          <div class="card" style="grid-column:1/-1;">
            <h3>Items</h3>
            <ul>${items}</ul>
          </div>
        `;

        const select = document.getElementById("status-select");
        select.value = order.status;
        document.getElementById("save-status").onclick = async () => {
          try {
            await apiFetch(`/orders/${order._id}/status`, {
              method: "PATCH",
              body: JSON.stringify({ status: select.value }),
            });
            statusEl.textContent = "Status updated";
            statusEl.classList.add("show", "success");
            setTimeout(() => window.location.reload(), 600);
          } catch (err) {
            statusEl.textContent = err.message;
            statusEl.classList.add("show", "error");
          }
        };
      }

      apiFetch(`/orders/${orderId}`)
        .then(renderOrder)
        .catch((err) => {
          statusEl.textContent = err.message;
          statusEl.classList.add("show", "error");
          content.innerHTML = "<p>Could not load order.</p>";
        });
    })();
  </script>
</body>
</html>
