<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Add/Edit Product | LocalPick Shop</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="../static/css/styles.css">
  <link rel="stylesheet" href="../static/css/shop.css">
</head>
<body class="auth-body">
  <div data-include="../includes/header.html"></div>
  <main class="shop-shell">
    <div class="container shop-grid">
      <div class="card">
        <div class="toolbar">
          <div>
            <h2 id="form-title">Add Product</h2>
            <p class="helper-text">Create or edit a product for your shop.</p>
          </div>
          <a class="ghost-btn" href="manage.html"><i class="bi bi-arrow-left"></i> Back to list</a>
        </div>
        <div class="page-status"></div>
        <form id="product-form" class="form-grid">
          <div class="split">
            <label>
              Name
              <input type="text" name="name" required>
            </label>
            <label>
              Category
              <input type="text" name="category" placeholder="e.g. Grocery">
            </label>
          </div>
          <div class="split">
            <label>
              Price
              <input type="number" name="price" step="0.01" required>
            </label>
            <label>
              Sale Price (optional)
              <input type="number" name="salePrice" step="0.01">
            </label>
          </div>
          <div class="split">
            <label>
              Stock Quantity
              <input type="number" name="stock" min="0" required>
            </label>
            <label>
              SKU / Product Code
              <input type="text" name="sku">
            </label>
          </div>
          <div class="split">
            <label>
              Unit
              <input type="text" name="unit" placeholder="kg, piece, packet">
            </label>
            <label>
              Status
              <select name="status">
                <option value="active">Active</option>
                <option value="inactive">Inactive</option>
              </select>
            </label>
          </div>
          <label>
            Description
            <textarea name="description" rows="4"></textarea>
          </label>
          <label>
            Tags (comma separated)
            <input type="text" name="tags" placeholder="fresh,organic">
          </label>
          <label>
            Images (1-4 URLs, comma separated)
            <input type="text" name="images" placeholder="https://...">
          </label>
          <button type="submit" class="primary-btn full solid" id="submit-btn">Save Product</button>
        </form>
      </div>
    </div>
  </main>

  <script src="../static/js/includes.js"></script>
  <script src="../static/js/shop-api.js"></script>
  <script>
    (function () {
      const form = document.getElementById("product-form");
      const submitBtn = document.getElementById("submit-btn");
      const formTitle = document.getElementById("form-title");
      const productId = qs("id");
      const shopId = getShopId();
      const statusEl = document.querySelector(".page-status");

      if (!shopId) {
        renderStatus(
          `No shop found. Create your shop in Settings first. <a class="text-link" href="settings.html">Go to Settings</a>`,
          "error"
        );
        form.innerHTML =
          '<p style="text-align:center;margin:12px 0;">Redirecting to shop settings...</p>';
        setTimeout(() => {
          window.location.href = "settings.html";
        }, 1200);
        return;
      }

      async function loadProduct() {
        if (!productId) return;
        formTitle.textContent = "Edit Product";
        submitBtn.textContent = "Update Product";
        const data = await apiFetch(`/products/${productId}`);
        form.name.value = data.name || "";
        form.category.value = data.category || "";
        form.price.value = data.price ?? "";
        form.salePrice.value = data.salePrice ?? "";
        form.stock.value = data.stock ?? 0;
        form.sku.value = data.sku || "";
        form.unit.value = data.unit || "";
        form.status.value = data.status || "active";
        form.description.value = data.description || "";
        form.tags.value = (data.tags || []).join(",");
        form.images.value = (data.images || []).join(",");
      }

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        submitBtn.disabled = true;
        renderStatus("Saving...");
        const payload = {
          shopId,
          name: form.name.value,
          category: form.category.value,
          price: Number(form.price.value),
          salePrice: form.salePrice.value ? Number(form.salePrice.value) : null,
          stock: Number(form.stock.value),
          sku: form.sku.value,
          unit: form.unit.value || "piece",
          status: form.status.value,
          description: form.description.value,
          tags: form.tags.value ? form.tags.value.split(",").map((t) => t.trim()).filter(Boolean) : [],
          images: form.images.value ? form.images.value.split(",").map((t) => t.trim()).filter(Boolean).slice(0, 4) : [],
        };
        try {
          if (productId) {
            await apiFetch(`/products/${productId}`, { method: "PUT", body: JSON.stringify(payload) });
          } else {
            await apiFetch(`/products`, { method: "POST", body: JSON.stringify(payload) });
          }
          renderStatus("Saved successfully", "success");
          setTimeout(() => (window.location.href = "manage.html"), 600);
        } catch (err) {
          renderStatus(err.message, "error");
        } finally {
          submitBtn.disabled = false;
        }
      });

      if (productId) {
        loadProduct().catch((err) => renderStatus(err.message, "error"));
      }
    })();
  </script>
</body>
</html>
